<!-- Modale de sondage (affichée après vérification OTP si activé) -->
<app-fenetre-sondage
  [visible]="afficherSondage()"
  [obligatoire]="true"
  (valider)="validerSondage($event)"
></app-fenetre-sondage>

<!-- Formulaire OTP (masqué si sondage affiché) -->
<div
  *ngIf="!afficherSondage()"
  class="grid min-h-screen px-3 py-4 bg-white place-items-center sm:px-4 md:px-6 sm:py-6"
>
  <div
    class="w-full max-w-[95vw] sm:max-w-md md:max-w-lg lg:max-w-xl rounded-xl sm:rounded-2xl bg-white text-[#0B1F2C] p-4 sm:p-6 md:p-8 shadow-xl sm:shadow-2xl border border-slate-200"
  >
    <div class="w-full h-1 mb-4 bg-green-400 rounded sm:mb-6"></div>

    <div class="flex items-center justify-between text-xs sm:text-sm">
      <span></span>
      <a routerLink="/register" class="transition-colors text-slate-500 hover:text-slate-700"
        >Retour</a
      >
    </div>

    <h2 class="mt-2 text-xl font-bold sm:text-2xl md:text-3xl">Entrez le code OTP</h2>
    <p class="mt-1 text-sm break-words sm:text-base text-slate-500">
      Un code à 6 chiffres a été envoyé à
      <b class="break-all">{{ email() || 'votre email' }}.</b> N'hésitez pas
      <b>à vérifier vos spams</b>
      pour obtenir votre code OTP.
    </p>

    <!-- Afficher les erreurs -->
    <div
      *ngIf="error()"
      class="px-3 py-2 mt-3 text-sm text-red-700 border border-red-300 rounded-md sm:mt-4 bg-red-50 sm:px-4 sm:py-3 sm:text-base"
    >
      {{ error() }}
    </div>

    <!-- Afficher les messages de succès -->
    <div
      *ngIf="success()"
      class="px-3 py-2 mt-3 text-sm text-green-700 border border-green-300 rounded-md sm:mt-4 bg-green-50 sm:px-4 sm:py-3 sm:text-base"
    >
      {{ success() }}
    </div>

    <!-- Inputs OTP -->
    <div class="mt-4 sm:mt-6 flex items-center justify-center gap-1.5 xs:gap-2 sm:gap-3">
      <input
        #otpInput
        type="text"
        inputmode="numeric"
        maxlength="1"
        (input)="onInput(0, $event)"
        (keydown)="onKeyDown(0, $event)"
        [class.border-red-400]="error()"
        class="w-10 h-10 text-base font-bold text-center transition border-2 rounded-md xs:w-11 xs:h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 sm:text-lg md:text-xl focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
      />
      <input
        #otpInput
        type="text"
        inputmode="numeric"
        maxlength="1"
        (input)="onInput(1, $event)"
        (keydown)="onKeyDown(1, $event)"
        [class.border-red-400]="error()"
        class="w-10 h-10 text-base font-bold text-center transition border-2 rounded-md xs:w-11 xs:h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 sm:text-lg md:text-xl focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
      />
      <input
        #otpInput
        type="text"
        inputmode="numeric"
        maxlength="1"
        (input)="onInput(2, $event)"
        (keydown)="onKeyDown(2, $event)"
        [class.border-red-400]="error()"
        class="w-10 h-10 text-base font-bold text-center transition border-2 rounded-md xs:w-11 xs:h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 sm:text-lg md:text-xl focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
      />
      <input
        #otpInput
        type="text"
        inputmode="numeric"
        maxlength="1"
        (input)="onInput(3, $event)"
        (keydown)="onKeyDown(3, $event)"
        [class.border-red-400]="error()"
        class="w-10 h-10 text-base font-bold text-center transition border-2 rounded-md xs:w-11 xs:h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 sm:text-lg md:text-xl focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
      />
      <input
        #otpInput
        type="text"
        inputmode="numeric"
        maxlength="1"
        (input)="onInput(4, $event)"
        (keydown)="onKeyDown(4, $event)"
        [class.border-red-400]="error()"
        class="w-10 h-10 text-base font-bold text-center transition border-2 rounded-md xs:w-11 xs:h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 sm:text-lg md:text-xl focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
      />
      <input
        #otpInput
        type="text"
        inputmode="numeric"
        maxlength="1"
        (input)="onInput(5, $event)"
        (keydown)="onKeyDown(5, $event)"
        [class.border-red-400]="error()"
        class="w-10 h-10 text-base font-bold text-center transition border-2 rounded-md xs:w-11 xs:h-11 sm:w-12 sm:h-12 md:w-14 md:h-14 sm:text-lg md:text-xl focus:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-200"
      />
    </div>

    <!-- Message d'aide -->
    <p class="mt-3 text-xs text-center sm:mt-4 sm:text-sm text-slate-500">
      Vous n'avez pas reçu le code ?
    </p>

    <!-- Actions -->
    <div
      class="flex flex-col items-stretch justify-center gap-2 mt-3 sm:mt-4 sm:flex-row sm:items-center sm:gap-3"
    >
      <button
        type="button"
        (click)="resend()"
        [disabled]="counter() > 0"
        class="w-full px-3 py-2 text-sm font-medium transition border rounded-md sm:w-auto border-slate-300 hover:border-slate-400 sm:px-4 sm:text-base disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Renvoyer
        <span *ngIf="counter() > 0" class="ml-1 text-slate-500">({{ counter() }}s)</span>
      </button>
      <button
        type="button"
        (click)="verify()"
        [disabled]="digits().join('').length !== 6 || verificationEnCours()"
        class="relative w-full px-4 py-2 text-sm font-semibold text-white transition bg-green-500 rounded-md sm:w-auto hover:bg-green-600 sm:px-6 sm:text-base disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <span [class.opacity-0]="verificationEnCours()">Vérifier & continuer</span>

        <!-- Spinner animé -->
        <svg
          *ngIf="verificationEnCours()"
          class="absolute w-5 h-5 text-white -translate-x-1/2 -translate-y-1/2 animate-spin left-1/2 top-1/2"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      </button>
    </div>
  </div>
</div>
