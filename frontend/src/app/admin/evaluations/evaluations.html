<!-- ADMIN EVALUATIONS — FPBG -->
<div class="w-full">
  <div class="grid gap-6 md:grid-cols-[280px,1fr]">
    <!-- ===== SIDEBAR ===== -->
    <aside
      class="hidden text-xs font-medium bg-white border shadow-sm md:block md:sticky md:top-0 md:self-start md:min-h-screen text-slate-600"
    >
      <div class="p-6 border-b">
        <p class="text-xl font-bold tracking-wider text-emerald-400 uppercase">
          Espace Administrateur
        </p>

        <div class="grid grid-cols-2 gap-2 mt-4 text-center">
          <div class="p-3 rounded bg-slate-100">
            <p class="text-[11px] text-green-400">Projets</p>
            <p class="text-lg font-semibold text-slate-600">{{ totalProjets() }}</p>
          </div>
          <div class="p-3 rounded bg-slate-100">
            <p class="text-[11px] text-green-400">Appel à Projets</p>
            <p class="text-lg font-semibold text-slate-600">{{ totalAAP() }}</p>
          </div>
        </div>
      </div>

      <nav class="p-2 text-sm">
        <div class="px-3 py-2 text-slate-600">Navigation</div>

        <a
          routerLink="/admin/dashboard"
          routerLinkActive="bg-green-500/10 border-l-4 border-green-500"
          [routerLinkActiveOptions]="{ exact: true }"
          class="block px-3 py-2 cursor-pointer hover:bg-green-500/10 hover:border-l-4 hover:border-green-500"
        >
          Vue d'ensemble
        </a>

        <a
          routerLink="/admin/projets"
          routerLinkActive="bg-green-500/10 border-l-4 border-green-500"
          class="block px-3 py-2 cursor-pointer hover:bg-green-500/10 hover:border-l-4 hover:border-green-500"
        >
          Projets
        </a>

        <a
          routerLink="/admin/evaluateurs"
          routerLinkActive="bg-green-500/10 border-l-4 border-green-500"
          class="block px-3 py-2 cursor-pointer hover:bg-green-500/10 hover:border-l-4 hover:border-green-500"
        >
          Evaluateurs
        </a>

        <a
          routerLink="/admin/evaluations"
          routerLinkActive="bg-green-500/10 border-l-4 border-green-500"
          class="block px-3 py-2 cursor-pointer hover:bg-green-500/10 hover:border-l-4 hover:border-green-500"
        >
          Evaluations
        </a>

        <a
          routerLink="/admin/statistiques"
          routerLinkActive="bg-green-500/10 border-l-4 border-green-500"
          class="block px-3 py-2 cursor-pointer hover:bg-green-500/10 hover:border-l-4 hover:border-green-500"
        >
          Statistiques
        </a>

        <a
          routerLink="/admin/historique"
          routerLinkActive="bg-green-500/10 border-l-4 border-green-500"
          class="block px-3 py-2 cursor-pointer hover:bg-green-500/10 hover:border-l-4 hover:border-green-500"
        >
          Historique des actions
        </a>
      </nav>

      <div class="p-2 mt-3 border-t">
        <button
          type="button"
          class="w-full px-3 py-2 text-left hover:bg-green-500/10"
          (click)="logout()"
        >
          Se déconnecter
        </button>
      </div>
    </aside>

    <!-- ===== MAIN ===== -->
    <section class="min-h-screen px-4 md:pr-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div class="min-w-0 flex-1">
          <h1 class="pt-3 text-2xl sm:text-3xl"><strong>Evaluations</strong></h1>
          <p class="pt-3 text-sm sm:text-base text-slate-600">Gestion des sessions d'évaluations</p>
        </div>

        <div class="flex items-center gap-3">
          <button
            type="button"
            class="inline-flex items-center gap-2 px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50"
            (click)="ouvrirModalParametrage()"
          >
            Parametrage
          </button>

          <button
            type="button"
            class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            (click)="ouvrirModalNouvelleSession()"
          >
            Nouvelle session
          </button>
        </div>
      </div>

      <!-- Loading -->
      <div *ngIf="loading()" class="flex items-center justify-center py-12 mt-8">
        <svg
          class="w-10 h-10 text-green-600 animate-spin"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
      </div>

      <!-- ===== Tableau des sessions ===== -->
      <div *ngIf="!loading()" class="mt-6">
        <h2 class="text-lg font-semibold mb-4">Sessions d'évaluations</h2>

        <div class="bg-white border rounded-xl overflow-hidden">
          <div class="relative max-h-[70vh] overflow-auto">
            <table class="w-full border-collapse table-fixed">
              <thead class="sticky top-0 z-20 shadow-sm bg-slate-50">
                <tr class="text-xs font-medium tracking-wide text-left uppercase text-slate-600">
                  <th class="px-3 py-3 w-[15%]">Intitule</th>
                  <th class="px-3 py-3 w-[25%]">Appels d'offres</th>
                  <th class="px-3 py-3 w-[10%]">Projets</th>
                  <th class="px-3 py-3 w-[10%]">Evaluateurs</th>
                  <th class="px-3 py-3 w-[12%]">Statut</th>
                  <th class="px-3 py-3 w-[18%]">Période</th>
                  <th class="px-3 py-3 w-[10%] text-right">Action</th>
                </tr>
              </thead>

              <tbody class="divide-y">
                <tr
                  *ngFor="let session of sessions(); trackBy: trackById"
                  class="hover:bg-slate-50"
                >
                  <td class="px-3 py-4">{{ session.intitule }}</td>
                  <td class="px-3 py-4 text-sm text-slate-600">{{ session.appelOffre }}</td>
                  <td class="px-3 py-4 text-center">{{ session.nbProjets }}</td>
                  <td class="px-3 py-4 text-center">{{ session.nbEvaluateurs }}</td>
                  <td class="px-3 py-4">
                    <span
                      class="inline-block rounded-full px-2 py-0.5 text-xs font-medium"
                      [ngClass]="getStatutClass(session.statut)"
                    >
                      {{ session.statut }}
                    </span>
                  </td>
                  <td class="px-3 py-4 text-xs text-slate-600">
                    {{ session.dateDebut }} - {{ session.dateFin }}
                  </td>
                  <td class="px-3 py-4 text-right">
                    <button
                      type="button"
                      class="px-3 py-1.5 rounded-lg border text-xs hover:bg-slate-50"
                      (click)="ouvrirModalVoir(session)"
                    >
                      Voir
                    </button>
                  </td>
                </tr>

                <tr *ngIf="sessions().length === 0">
                  <td colspan="7" class="px-4 py-10 text-center text-slate-500">
                    <p>Aucune session d'évaluation trouvée</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- ===== MODALE: Nouvelle Session - Étape 1 ===== -->
<div
  *ngIf="modalNouvelleSession() && etapeNouvelleSession() === 1"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
  (click)="fermerModalNouvelleSession()"
>
  <div
    class="bg-white rounded-xl shadow-xl w-[90%] max-w-4xl max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold">Sessions d'évaluations</h2>
        <div class="flex gap-3">
          <button
            type="button"
            class="px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50"
            (click)="fermerModalNouvelleSession()"
          >
            Annuler
          </button>
          <button
            type="button"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            (click)="allerEtape(2)"
            [disabled]="!peutAllerEtape2()"
          >
            Suivant
          </button>
        </div>
      </div>

      <div class="mb-4">
        <select
          [(ngModel)]="nouvelleSessionData.appelOffreId"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          <option value="">Sélectionner un appel d'offre</option>
          <option *ngFor="let aap of appelOffres()" [value]="aap.id">{{ aap.nom }}</option>
        </select>
      </div>

      <div class="mb-4">
        <input
          type="text"
          [(ngModel)]="nouvelleSessionData.intitule"
          placeholder="Intitulé"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <p class="text-sm text-slate-500 mb-4">
        Veuillez sélectionner les projets concernés par la session d'évaluation
      </p>

      <!-- Tableau de sélection des projets -->
      <div class="border rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr class="text-xs font-medium text-left uppercase text-slate-600">
              <th class="px-3 py-3">Organisation</th>
              <th class="px-3 py-3">Projets</th>
              <th class="px-3 py-3">Porteur</th>
              <th class="px-3 py-3">Date de soumission</th>
              <th class="px-3 py-3 text-center">
                <input
                  type="checkbox"
                  [checked]="tousProjetsCochesEtape1()"
                  (change)="toggleTousProjetsEtape1($event)"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                />
              </th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <tr *ngFor="let projet of projetsFiltres()" class="hover:bg-slate-50">
              <td class="px-3 py-3 text-sm text-slate-600">{{ projet.organisation }}</td>
              <td class="px-3 py-3 text-sm">{{ projet.nom }}</td>
              <td class="px-3 py-3 text-sm text-slate-600">{{ projet.porteur }}</td>
              <td class="px-3 py-3 text-xs text-slate-600">{{ projet.dateSoumission }}</td>
              <td class="px-3 py-3 text-center">
                <input
                  type="checkbox"
                  [checked]="nouvelleSessionData.projetsIds.includes(projet.id)"
                  (change)="toggleProjetSelection(projet.id)"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                />
              </td>
            </tr>
            <tr *ngIf="projetsFiltres().length === 0">
              <td colspan="5" class="px-4 py-6 text-center text-slate-500">
                <p class="text-sm">Aucun projet disponible</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALE: Nouvelle Session - Étape 2 ===== -->
<div
  *ngIf="modalNouvelleSession() && etapeNouvelleSession() === 2"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
  (click)="fermerModalNouvelleSession()"
>
  <div
    class="bg-white rounded-xl shadow-xl w-[90%] max-w-4xl max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold">Sessions d'évaluations</h2>
        <div class="flex gap-3">
          <button
            type="button"
            class="px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50"
            (click)="allerEtape(1)"
          >
            Retour
          </button>
          <button
            type="button"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            (click)="creerSession()"
            [disabled]="!peutCreerSession()"
          >
            Valider
          </button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Date debut</label>
          <input
            type="date"
            [(ngModel)]="nouvelleSessionData.dateDebut"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Date fin</label>
          <input
            type="date"
            [(ngModel)]="nouvelleSessionData.dateFin"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
          />
        </div>
      </div>

      <div class="mb-4">
        <select
          [(ngModel)]="nouvelleSessionData.grilleEvaluationId"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          <option value="">Sélectionner grille d'évaluation</option>
          <option *ngFor="let grille of grillesEvaluation()" [value]="grille.id">
            {{ grille.titre }}
          </option>
        </select>
      </div>

      <p class="text-sm text-slate-500 mb-4">
        Veuillez sélectionner les évaluateurs concernés par la session d'évaluation
      </p>

      <!-- Tableau de sélection des évaluateurs -->
      <div class="border rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr class="text-xs font-medium text-left uppercase text-slate-600">
              <th class="px-3 py-3">Prenom</th>
              <th class="px-3 py-3">Nom</th>
              <th class="px-3 py-3">Adresse email</th>
              <th class="px-3 py-3">Date de creation</th>
              <th class="px-3 py-3">Projets evalues</th>
              <th class="px-3 py-3 text-center">
                <input
                  type="checkbox"
                  [checked]="tousEvaluateursCochesEtape2()"
                  (change)="toggleTousEvaluateursEtape2($event)"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                />
              </th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <tr *ngFor="let evaluateur of evaluateurs()" class="hover:bg-slate-50">
              <td class="px-3 py-3 text-sm">{{ evaluateur.prenom }}</td>
              <td class="px-3 py-3 text-sm">{{ evaluateur.nom }}</td>
              <td class="px-3 py-3 text-sm text-slate-600">{{ evaluateur.email }}</td>
              <td class="px-3 py-3 text-xs text-slate-600">{{ evaluateur.dateCreation }}</td>
              <td class="px-3 py-3 text-center text-sm">{{ evaluateur.nbProjetsEvalues }}</td>
              <td class="px-3 py-3 text-center">
                <input
                  type="checkbox"
                  [checked]="nouvelleSessionData.evaluateursIds.includes(evaluateur.id)"
                  (change)="toggleEvaluateurSelection(evaluateur.id)"
                  class="w-4 h-4 text-green-600 rounded focus:ring-green-500"
                />
              </td>
            </tr>
            <tr *ngIf="evaluateurs().length === 0">
              <td colspan="6" class="px-4 py-6 text-center text-slate-500">
                <p class="text-sm">Aucun évaluateur disponible</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALE: Voir Session ===== -->
<div
  *ngIf="modalVoir()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
  (click)="fermerModalVoir()"
>
  <div
    class="bg-white rounded-xl shadow-xl w-[90%] max-w-5xl max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold">{{ sessionSelectionnee()?.intitule }}</h2>
        <button
          type="button"
          class="px-4 py-2 border rounded-lg hover:bg-slate-50"
          (click)="fermerModalVoir()"
        >
          Fermer
        </button>
      </div>

      <!-- Onglets -->
      <div class="flex gap-4 mb-6 border-b">
        <button
          type="button"
          class="px-4 py-2 border-b-2"
          [ngClass]="
            ongletVoir() === 'projets'
              ? 'border-green-600 text-green-600'
              : 'border-transparent text-slate-600'
          "
          (click)="changerOngletVoir('projets')"
        >
          Projets
        </button>
        <button
          type="button"
          class="px-4 py-2 border-b-2"
          [ngClass]="
            ongletVoir() === 'evaluateurs'
              ? 'border-green-600 text-green-600'
              : 'border-transparent text-slate-600'
          "
          (click)="changerOngletVoir('evaluateurs')"
        >
          Evaluateurs
        </button>
      </div>

      <!-- Contenu onglet Projets -->
      <div *ngIf="ongletVoir() === 'projets'" class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead class="bg-slate-50">
            <tr class="text-xs font-medium text-left uppercase text-slate-600">
              <th class="px-3 py-3 border">Projets</th>
              <th
                *ngFor="let evaluateur of sessionSelectionnee()?.evaluateurs"
                class="px-3 py-3 border text-center"
              >
                {{ evaluateur.prenom }} {{ evaluateur.nom }}
              </th>
              <th class="px-3 py-3 border text-center">Note moyenne</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let projet of sessionSelectionnee()?.projets" class="hover:bg-slate-50">
              <td class="px-3 py-3 border">{{ projet.nom }}</td>
              <td *ngFor="let note of projet.notes" class="px-3 py-3 border text-center">
                {{ note }}%
              </td>
              <td class="px-3 py-3 border text-center font-semibold">{{ projet.noteMoyenne }}%</td>
            </tr>
            <tr
              *ngIf="
                !sessionSelectionnee()?.projets ||
                (sessionSelectionnee()?.projets?.length ?? 0) === 0
              "
            >
              <td
                [attr.colspan]="(sessionSelectionnee()?.evaluateurs?.length ?? 0) + 2"
                class="px-4 py-6 text-center text-slate-500"
              >
                <p class="text-sm">Aucun projet dans cette session</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Contenu onglet Evaluateurs -->
      <div *ngIf="ongletVoir() === 'evaluateurs'">
        <p class="text-sm text-slate-500 mb-4">Liste des évaluateurs assignés à cette session</p>
        <div class="grid gap-3">
          <div
            *ngFor="let evaluateur of sessionSelectionnee()?.evaluateurs"
            class="p-4 border rounded-lg"
          >
            <p class="font-medium">{{ evaluateur.prenom }} {{ evaluateur.nom }}</p>
            <p class="text-sm text-slate-600">{{ evaluateur.email }}</p>
          </div>
          <div
            *ngIf="
              !sessionSelectionnee()?.evaluateurs ||
              (sessionSelectionnee()?.evaluateurs?.length ?? 0) === 0
            "
            class="p-8 text-center text-slate-500"
          >
            <p class="text-sm">Aucun évaluateur assigné à cette session</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALE: Paramétrage (Grilles d'évaluation) ===== -->
<div
  *ngIf="modalParametrage()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
  (click)="fermerModalParametrage()"
>
  <div
    class="bg-white rounded-xl shadow-xl w-[90%] max-w-4xl max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <button
          type="button"
          class="px-4 py-2 border border-green-600 text-green-600 rounded-lg hover:bg-green-50"
          (click)="ouvrirModalNouvelleGrille()"
        >
          Nouvelle grille
        </button>
        <button
          type="button"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          (click)="fermerModalParametrage()"
        >
          Enregistrer
        </button>
      </div>

      <!-- Liste des grilles -->
      <div class="border rounded-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr class="text-xs font-medium text-left uppercase text-slate-600">
              <th class="px-3 py-3">Titre</th>
              <th class="px-3 py-3">Description</th>
              <th class="px-3 py-3">Date de creation</th>
              <th class="px-3 py-3 text-center">Note max</th>
              <th class="px-3 py-3 text-center">Note min</th>
              <th class="px-3 py-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <tr *ngFor="let grille of grillesEvaluation()" class="hover:bg-slate-50">
              <td class="px-3 py-3">{{ grille.titre }}</td>
              <td class="px-3 py-3 text-sm text-slate-600">{{ grille.description }}</td>
              <td class="px-3 py-3 text-xs text-slate-600">{{ grille.dateCreation }}</td>
              <td class="px-3 py-3 text-center">{{ grille.noteMax }}</td>
              <td class="px-3 py-3 text-center">{{ grille.noteMin }}</td>
              <td class="px-3 py-3 text-center">
                <div class="flex items-center justify-center gap-2">
                  <button
                    type="button"
                    class="text-blue-600 hover:text-blue-800"
                    (click)="modifierGrille(grille)"
                    title="Modifier"
                  >
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path
                        d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                        stroke-width="2"
                      ></path>
                      <path
                        d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                        stroke-width="2"
                      ></path>
                    </svg>
                  </button>
                  <button
                    type="button"
                    class="text-red-600 hover:text-red-800"
                    (click)="supprimerGrille(grille.id)"
                    title="Supprimer"
                  >
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M3 6h18" stroke-width="2"></path>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" stroke-width="2"></path>
                      <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke-width="2"></path>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="grillesEvaluation().length === 0">
              <td colspan="6" class="px-4 py-10 text-center text-slate-500">
                <p>Aucune grille d'évaluation trouvée</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALE: Nouvelle/Modifier Grille ===== -->
<div
  *ngIf="modalNouvelleGrille()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
  (click)="fermerModalNouvelleGrille()"
>
  <div
    class="bg-white rounded-xl shadow-xl w-[90%] max-w-5xl max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex gap-3">
          <button
            type="button"
            class="px-4 py-2 rounded-lg"
            [ngClass]="
              ongletGrille() === 'nouveau'
                ? 'bg-green-100 text-green-700'
                : 'bg-slate-100 text-slate-600'
            "
            (click)="changerOngletGrille('nouveau')"
          >
            Nouveau critere
          </button>
          <button
            type="button"
            class="px-4 py-2 rounded-lg"
            [ngClass]="
              ongletGrille() === 'titre'
                ? 'bg-green-100 text-green-700'
                : 'bg-slate-100 text-slate-600'
            "
            (click)="changerOngletGrille('titre')"
          >
            Titre
          </button>
          <button
            type="button"
            class="px-4 py-2 rounded-lg"
            [ngClass]="
              ongletGrille() === 'description'
                ? 'bg-green-100 text-green-700'
                : 'bg-slate-100 text-slate-600'
            "
            (click)="changerOngletGrille('description')"
          >
            Description
          </button>
          <button
            type="button"
            class="px-4 py-2 rounded-lg"
            [ngClass]="
              ongletGrille() === 'min'
                ? 'bg-green-100 text-green-700'
                : 'bg-slate-100 text-slate-600'
            "
            (click)="changerOngletGrille('min')"
          >
            Min
          </button>
        </div>
        <button
          type="button"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          (click)="enregistrerGrille()"
        >
          Enregistrer
        </button>
      </div>

      <!-- Onglet Nouveau Critere -->
      <div *ngIf="ongletGrille() === 'nouveau'">
        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-700 mb-1">Titre</label>
          <input
            type="text"
            [(ngModel)]="nouveauCritere.titre"
            placeholder="Pertinence du projet"
            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
          />
        </div>

        <!-- Liste des criteres existants -->
        <div class="space-y-4">
          <div
            *ngFor="let critere of grilleEnEdition.criteres; let i = index"
            class="border rounded-lg p-4"
          >
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-medium">{{ critere.titre }}</h3>
              <button
                type="button"
                class="text-green-600 hover:text-green-800 text-sm"
                (click)="ajouterSousCritere(i)"
              >
                + sous-critere
              </button>
            </div>

            <!-- Tableau des sous-criteres -->
            <div class="border rounded-lg overflow-hidden">
              <table class="w-full">
                <thead class="bg-slate-50">
                  <tr class="text-xs font-medium text-left uppercase text-slate-600">
                    <th class="px-3 py-3">Sous critere</th>
                    <th class="px-3 py-3">Description</th>
                    <th class="px-3 py-3 text-center">Points</th>
                    <th class="px-3 py-3 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y">
                  <tr
                    *ngFor="let sousCritere of critere.sousCriteres; let j = index"
                    class="hover:bg-slate-50"
                  >
                    <td class="px-3 py-3 text-sm">{{ sousCritere.titre }}</td>
                    <td class="px-3 py-3 text-sm text-slate-600">{{ sousCritere.description }}</td>
                    <td class="px-3 py-3 text-center">{{ sousCritere.points }}</td>
                    <td class="px-3 py-3 text-center">
                      <div class="flex items-center justify-center gap-2">
                        <button
                          type="button"
                          class="text-blue-600 hover:text-blue-800"
                          (click)="modifierSousCritere(i, j)"
                          title="Modifier"
                        >
                          <svg
                            class="w-4 h-4"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                          >
                            <path
                              d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                              stroke-width="2"
                            ></path>
                            <path
                              d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                              stroke-width="2"
                            ></path>
                          </svg>
                        </button>
                        <button
                          type="button"
                          class="text-red-600 hover:text-red-800"
                          (click)="supprimerSousCritere(i, j)"
                          title="Supprimer"
                        >
                          <svg
                            class="w-4 h-4"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                          >
                            <path d="M3 6h18" stroke-width="2"></path>
                            <path
                              d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"
                              stroke-width="2"
                            ></path>
                            <path
                              d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                              stroke-width="2"
                            ></path>
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr *ngIf="critere.sousCriteres.length === 0">
                    <td colspan="4" class="px-4 py-4 text-center text-slate-500 text-sm">
                      Aucun sous-critère
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Onglet Titre -->
      <div *ngIf="ongletGrille() === 'titre'">
        <input
          type="text"
          [(ngModel)]="grilleEnEdition.titre"
          placeholder="Titre de la grille"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <!-- Onglet Description -->
      <div *ngIf="ongletGrille() === 'description'">
        <textarea
          [(ngModel)]="grilleEnEdition.description"
          placeholder="Description de la grille"
          rows="6"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        ></textarea>
      </div>

      <!-- Onglet Min -->
      <div *ngIf="ongletGrille() === 'min'">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Note minimale</label>
            <input
              type="number"
              [(ngModel)]="grilleEnEdition.noteMin"
              placeholder="0"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Note maximale</label>
            <input
              type="number"
              [(ngModel)]="grilleEnEdition.noteMax"
              placeholder="100"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALE: Ajouter/Modifier Sous-Critere ===== -->
<div
  *ngIf="modalSousCritere()"
  class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50"
  (click)="fermerModalSousCritere()"
>
  <div class="bg-white rounded-xl shadow-xl w-[90%] max-w-lg" (click)="$event.stopPropagation()">
    <div class="p-6">
      <h3 class="text-lg font-semibold mb-4">Sous critere</h3>

      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-700 mb-1">Sous critere</label>
        <input
          type="text"
          [(ngModel)]="sousCritereEnEdition.titre"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
        <textarea
          [(ngModel)]="sousCritereEnEdition.description"
          rows="3"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        ></textarea>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-slate-700 mb-1">Points</label>
        <input
          type="number"
          [(ngModel)]="sousCritereEnEdition.points"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <div class="flex justify-end gap-3">
        <button
          type="button"
          class="px-4 py-2 border rounded-lg hover:bg-slate-50"
          (click)="fermerModalSousCritere()"
        >
          Annuler
        </button>
        <button
          type="button"
          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          (click)="enregistrerSousCritere()"
        >
          Ajouter
        </button>
      </div>
    </div>
  </div>
</div>
